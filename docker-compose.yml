version: '3'

volumes:
    website_db:
    website_data_1:
    website_data_2:

services:

    website:
        build:
            context: ./docker
            dockerfile: python.Dockerfile
            image: python3_virtualenv
        env_file:
            - .env
        expose:
            - ${PORT_WEBSITE}
        ports:
            - ${PORT_WEBSOCKET}:${PORT_WEBSOCKET}
            #- ${PORT_WEBSITE}:${PORT_WEBSITE}
        environment:
            - PORT_WEBSITE
            - PORT_WEBSOCKET
        links:
            - postgres
        volumes:
            - ${PATH_HOST_MEDIA}:${PATH_CONTAINER_MEDIA}:ro
            - ./:${PATH_CONTAINER_REPO}:ro
            - website_data_1:${PATH_CONTAINER_WEBSITE}/data
            - website_data_2:${PATH_CONTAINER_WEBSITE}/KaraKara.egg-info
            #- ./production.inidiff:${PATH_CONTAINER_WEBSITE}/data/config/production.inidiff:ro  # Use .env vars with KARAKARA_SETTINGS_KEY=[00:01:00, 00:02:00] -> timedelta instead
        command: make run_production --directory ${PATH_CONTAINER_WEBSITE}

    postgres:
        image: postgres:9-alpine
        volumes:
            - website_db:/var/lib/postgresql
            - ./docker/postgres:/docker-entrypoint-initdb.d

    nginx:
        image: nginx:mainline-alpine
        environment:
            - PORT_NGINX
            - PORT_WEBSITE
        env_file:
            - .env
        ports:
            - "${PORT_NGINX}:${PORT_NGINX}"
        volumes:
            - ./docker/nginx.conf:/tmp/nginx.conf:ro
            - ${PATH_HOST_MEDIA}:${PATH_CONTAINER_MEDIA}:ro
            - ./:${PATH_CONTAINER_REPO}:ro
            - website_data_1:${PATH_CONTAINER_WEBSITE}/data:ro
        links:
            - website
        command: /bin/sh -c "DOLLAR='$$' envsubst < /tmp/nginx.conf > /etc/nginx/nginx.conf && nginx -g 'daemon off;'"
